<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Equipe [ODIO]</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&display=swap" rel="stylesheet" />

<style>
  body { font-family: 'Oswald', sans-serif; background: #050505; color: #eee; }
  .admin-only { display: none; }
  input[type="file"] { font-size: 10px; }
</style>
</head>
<body class="pb-10">

<!-- BANNER -->
<section class="relative w-full h-[300px] md:h-[400px] bg-zinc-900 border-b-4 border-red-600">
  <img id="bannerImg" src="https://images.alphacoders.com" class="w-full h-full object-cover opacity-60" alt="Banner" />
  <div class="absolute bottom-10 left-10">
    <h2 class="text-5xl font-bold italic uppercase">Equipe <span class="text-red-600">[ODIO]</span></h2>
  </div>
</section>

<nav class="max-w-6xl mx-auto flex justify-between items-center p-6 bg-zinc-900 border-b border-zinc-800">
  <button onclick="abrirModal()" class="bg-red-600 px-6 py-2 rounded text-xs font-bold uppercase">Alistar-se</button>
  <button onclick="loginAdmin()" class="text-zinc-400 text-xs uppercase">Admin</button>
</nav>

<main class="max-w-6xl mx-auto p-4 mt-8 space-y-10">

  <!-- ADMIN PANEL -->
  <section id="adminPanel" class="admin-only space-y-6">
    <div class="bg-zinc-900 p-6 rounded border-2 border-yellow-600">

      <!-- Botão Editar Banner -->
      <button onclick="abrirModalBanner()" class="bg-yellow-600 px-4 py-2 text-black font-bold rounded mb-4">✏️ Editar Banner</button>

      <!-- Recrutas -->
      <h3 class="text-yellow-500 font-bold mb-3 uppercase">Recrutas</h3>
      <div id="listaEspera" class="space-y-2"></div>

      <!-- Lista de aprovados -->
      <h3 class="text-yellow-500 font-bold mb-3 uppercase mt-4">Lista de Aprovados (Admin)</h3>
      <div id="listaAprovados" class="space-y-2"></div>
    </div>
  </section>

  <!-- RANK -->
  <div class="bg-zinc-900 rounded border border-zinc-800 overflow-hidden">
    <table class="w-full text-left">
      <thead class="bg-black text-zinc-500 text-xs uppercase">
        <tr>
          <th class="p-4">Rank</th>
          <th class="p-4">Soldado</th>
          <th class="p-4 text-center">Partidas</th>
          <th class="p-4 text-center text-red-500">Kills</th>
          <th class="p-4 text-right admin-only">Ações</th>
        </tr>
      </thead>
      <tbody id="rankBody"></tbody>
    </table>
  </div>
</main>

<!-- MODAL CADASTRO -->
<div id="modalCadastro" class="fixed inset-0 bg-black/90 flex items-center justify-center hidden p-4">
  <div class="bg-zinc-900 p-8 rounded border border-red-600 max-w-md w-full">
    <h2 class="text-2xl font-bold mb-6 text-center uppercase">Alistamento</h2>
    <div class="space-y-4">
      <input id="regNome" placeholder="Nick" class="w-full bg-black border border-zinc-700 p-3 rounded text-white" />
      <input id="regEmail" placeholder="Email" type="email" class="w-full bg-black border border-zinc-700 p-3 rounded text-white" />
      <input id="regFone" placeholder="Telefone" class="w-full bg-black border border-zinc-700 p-3 rounded text-white" />
      <button onclick="solicitarEntrada()" class="w-full bg-red-600 py-3 font-bold uppercase">Enviar</button>
      <button onclick="fecharModal()" class="w-full text-zinc-600 text-xs uppercase">Fechar</button>
    </div>
  </div>
</div>

<!-- MODAL BANNER -->
<div id="modalBanner" class="fixed inset-0 bg-black/90 flex items-center justify-center hidden p-4">
  <div class="bg-zinc-900 p-8 rounded border border-yellow-600 max-w-md w-full space-y-4">
    <h2 class="text-2xl font-bold text-center uppercase">Editar Banner</h2>
    <input id="newBannerUrl" type="text" placeholder="Coloque a URL da imagem" class="w-full bg-black border border-zinc-700 p-2 rounded text-white text-xs" />
    <input type="file" id="uploadBannerInput" />
    <div class="flex gap-2">
      <button onclick="updateBannerUrl()" class="bg-yellow-600 px-4 py-2 text-black font-bold rounded flex-1">Usar URL</button>
      <button onclick="uploadBannerLocalFromInput()" class="bg-yellow-700 px-4 py-2 text-black font-bold rounded flex-1">Usar Arquivo</button>
    </div>
    <button onclick="fecharModalBanner()" class="w-full text-zinc-600 text-xs uppercase mt-2">Fechar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDkwukyKZVEZKiP4J75tkUNDisqaC4KLlk",
  authDomain: "equipeodio-715f6.firebaseapp.com",
  projectId: "equipeodio-715f6",
  storageBucket: "equipeodio-715f6.firebasestorage.app",
  messagingSenderId: "399735990964",
  appId: "1:399735990964:web:6baa2428bc49c23d7845e1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const docRef = doc(db, "site", "dados");

let aprovados = [];
let espera = [];
window.listaAprovadosData = [];
let bannerSalvo = "https://images.alphacoders.com";
let isAdmin = false;

// Inicializa Firestore
async function inicializar() {
  const snap = await getDoc(docRef);
  if (!snap.exists()) await setDoc(docRef, { rank: [], espera: [], aprovados: [], banner: bannerSalvo });
}
await inicializar();

// Atualização em tempo real
onSnapshot(docRef, snap=>{
  if(snap.exists()){
    const d = snap.data();
    aprovados = d.rank || [];
    espera = d.espera || [];
    window.listaAprovadosData = d.aprovados || [];
    bannerSalvo = d.banner || bannerSalvo;
    document.getElementById("bannerImg").src = bannerSalvo;
    renderRank(); renderAdmin();
  }
});

// Salvar
async function salvar() {
  await setDoc(docRef, { rank: aprovados, espera: espera, aprovados: window.listaAprovadosData, banner: bannerSalvo });
}

// Modals
window.abrirModal = () => modalCadastro.classList.remove("hidden");
window.fecharModal = () => modalCadastro.classList.add("hidden");

window.abrirModalBanner = () => modalBanner.classList.remove("hidden");
window.fecharModalBanner = () => modalBanner.classList.add("hidden");

// Cadastro com verificação duplicados
window.solicitarEntrada = async () => {
  const nome = regNome.value.trim();
  const email = regEmail.value.trim();
  const fone = regFone.value.trim();
  if(!nome||!email||!fone){ alert("⚠️ Preencha todos os campos!"); return; }

  const snap = await getDoc(docRef);
  const data = snap.exists()? snap.data() : {espera:[], aprovados:[]};
  const duplicado = [...data.espera, ...data.aprovados].some(p => p.nome===nome || p.fone===fone || p.email===email);
  if(duplicado){ alert("❌ Este nick, telefone ou email já foi cadastrado!"); return; }

  espera.push({nome,email,fone,id:Date.now()});
  await salvar();
  alert("✅ Pedido enviado com sucesso!");
  regNome.value=""; regEmail.value=""; regFone.value="";
  fecharModal();
};

// Admin
window.aprovar = async (id)=>{
  const idx = espera.findIndex(p=>p.id===id);
  if(idx===-1) return;
  const j = espera.splice(idx,1)[0];
  aprovados.push({name:j.nome,matches:0,kills:0});
  window.listaAprovadosData.push({nome:j.nome,fone:j.fone,email:j.email});
  await salvar();
};
window.reprovar = async (id)=>{ espera=espera.filter(p=>p.id!==id); await salvar(); };
window.removerAprovado = async (email)=>{
  if(!confirm("Remover jogador da lista de aprovados?")) return;
  window.listaAprovadosData = window.listaAprovadosData.filter(p=>p.email!==email);
  aprovados = aprovados.filter(p=>p.name!==window.listaAprovadosData.find(x=>x.email===email)?.nome);
  await salvar();
};
window.addScore = async (nome)=>{
  const k = parseInt(prompt("Kills","0"))||0;
  const idx = aprovados.findIndex(p=>p.name===nome);
  if(idx>-1){ aprovados[idx].matches+=1; aprovados[idx].kills+=k; await salvar(); }
};
window.removerDoRank = async (nome)=>{
  aprovados = aprovados.filter(p=>p.name!==nome);
  window.listaAprovadosData = window.listaAprovadosData.filter(p=>p.nome!==nome);
  await salvar();
};
window.loginAdmin = ()=>{
  const senha = prompt("Senha:");
  if(senha==="123"){ isAdmin=true; document.querySelectorAll(".admin-only").forEach(e=>e.style.display="block"); }
  else if(senha!==null) alert("Senha incorreta!");
};

// Banner
window.updateBannerUrl = async ()=>{
  const url = newBannerUrl.value.trim();
  if(url){ bannerSalvo=url; document.getElementById("bannerImg").src=bannerSalvo; await salvar(); fecharModalBanner(); }
};
window.uploadBannerLocalFromInput = async ()=>{
  const file = uploadBannerInput.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = async (ev)=>{ bannerSalvo=ev.target.result; document.getElementById("bannerImg").src=bannerSalvo; await salvar(); fecharModalBanner(); }
  reader.readAsDataURL(file);
};

// Render
function renderRank(){
  rankBody.innerHTML="";
  aprovados.sort((a,b)=>b.kills-a.kills);
  aprovados.forEach((p,i)=>{
    rankBody.innerHTML+=`<tr class="border-b border-zinc-800">
      <td class="p-4">#${i+1}</td>
      <td class="p-4">${p.name}</td>
      <td class="p-4 text-center">${p.matches}</td>
      <td class="p-4 text-center text-red-500">${p.kills}</td>
      <td class="p-4 text-right admin-only" style="display:${isAdmin?'block':'none'}">
        <button onclick="addScore('${p.name}')" class="bg-blue-600 px-2 py-1 text-xs rounded">+K</button>
        <button onclick="removerDoRank('${p.name}')" class="text-red-500 ml-2">X</button>
      </td>
    </tr>`;
  });
}

function renderAdmin(){
  // Lista de espera
  listaEspera.innerHTML="";
  espera.forEach(p=>{
    listaEspera.innerHTML+=`<div class="bg-black p-2 rounded flex justify-between">
      <div>${p.nome} - ${p.fone}</div>
      <div>
        <button onclick="aprovar(${p.id})" class="bg-green-600 px-2 py-1 text-xs">V</button>
        <button onclick="reprovar(${p.id})" class="bg-red-600 px-2 py-1 text-xs">X</button>
      </div>
    </div>`;
  });

  // Lista de aprovados (Admin)
  listaAprovados.innerHTML="";
  window.listaAprovadosData.forEach(p=>{
    listaAprovados.innerHTML+=`<div class="bg-black p-2 rounded flex justify-between">
      <span>${p.nome} - ${p.fone}</span>
      <button onclick="removerAprovado('${p.email}')" class="bg-red-600 px-2 py-1 text-xs">Remover</button>
    </div>`;
  });
}

</script>

</body>
</html>
