<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Equipe [ODIO] - Oficial</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Oswald', sans-serif; background: #050505; color: #eee;}
button { cursor:pointer;}
.admin-only { display:none;}
</style>
</head>
<body>

<!-- BANNER -->
<section class="w-full h-[250px] bg-zinc-900 border-b-4 border-red-600">
<img id="bannerImg" class="w-full h-full object-cover opacity-70">
</section>

<!-- NAV -->
<nav class="max-w-6xl mx-auto flex justify-between items-center p-6 bg-zinc-900 border-b border-zinc-800">

  <div class="flex gap-4">
    <button onclick="abrirModal()" 
      class="bg-red-600 px-6 py-2 rounded text-xs font-bold uppercase">
      Alistar-se
    </button>

    <button onclick="abrirLogin()" 
      class="bg-blue-600 px-6 py-2 rounded text-xs font-bold uppercase">
      Login
    </button>
  </div>

  <button onclick="loginAdmin()" class="text-white text-xs uppercase">
    Painel Admin
  </button>

</nav>

<main class="max-w-6xl mx-auto p-6">

<section id="adminPanel" class="admin-only bg-zinc-900 p-4 rounded border-2 border-yellow-600 mb-6">
<h3 class="text-yellow-500 font-bold mb-3 uppercase">Recrutas (Aprovar/Reprovar)</h3>
<div id="listaEspera" class="space-y-2"></div>

<h3 class="text-yellow-500 font-bold mt-4 mb-2 uppercase">
Aprovados (<span id="contagemAprovados"></span>)
</h3>
<div id="listaAprovados" class="space-y-2"></div>
</section>

<!-- RANK -->
<div class="bg-zinc-900 rounded border border-zinc-800 overflow-hidden">
<table class="w-full text-left">
<thead class="bg-black text-zinc-500 text-xs uppercase">
<tr>
<th class="p-4">Rank</th>
<th class="p-4">Nome no COD</th>
<th class="p-4 text-center">Partidas</th>
<th class="p-4 text-center text-red-500">Kills</th>
</tr>
</thead>
<tbody id="rankBody"></tbody>
</table>
</div>

</main>

<!-- MODAL CADASTRO -->
<div id="modalCadastro" class="fixed inset-0 bg-black/90 flex items-center justify-center hidden p-4">
<div class="bg-zinc-900 p-6 rounded border border-red-600 max-w-md w-full">
<h2 class="text-xl font-bold mb-4 text-center uppercase">Alistamento</h2>

<input id="regNome" placeholder="Nome no COD"
class="w-full bg-black border border-zinc-700 p-3 rounded text-white mb-2">

<input id="regEmail" placeholder="Email"
class="w-full bg-black border border-zinc-700 p-3 rounded text-white mb-2">

<input id="regFone" placeholder="Telefone"
class="w-full bg-black border border-zinc-700 p-3 rounded text-white mb-2">

<button onclick="solicitarEntrada()"
class="w-full bg-red-600 py-3 font-bold uppercase">
Enviar
</button>

<button onclick="fecharModal()"
class="w-full text-zinc-500 text-xs uppercase mt-3">
Fechar
</button>
</div>
</div>

<!-- MODAL LOGIN -->
<div id="modalLogin" class="fixed inset-0 bg-black/90 flex items-center justify-center hidden p-4">
<div class="bg-zinc-900 p-8 rounded border border-blue-600 max-w-md w-full">

<h2 class="text-xl font-bold mb-4 text-center uppercase">Login</h2>

<input id="loginEmail" placeholder="Email"
class="w-full bg-black border border-zinc-700 p-3 rounded text-white mb-2">

<input id="loginSenha" type="password" placeholder="Senha"
class="w-full bg-black border border-zinc-700 p-3 rounded text-white mb-3">

<button onclick="fazerLogin()"
class="w-full bg-blue-600 py-3 font-bold uppercase">
Entrar
</button>

<button onclick="fecharLogin()"
class="w-full text-zinc-500 text-xs uppercase mt-3">
Fechar
</button>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* — SUA CONFIG FIREBASE — */
const firebaseConfig = {
  apiKey: "AIzaSyDkwukyKZVEZKiP4J75tkUNDisqaC4KLlk",
  authDomain: "equipeodio-715f6.firebaseapp.com",
  projectId: "equipeodio-715f6",
  storageBucket: "equipeodio-715f6.appspot.com",
  messagingSenderId: "399735990964",
  appId: "1:399735990964:web:6baa2428bc49c23d7845e1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const docRef = doc(db, "site", "dados");

let rank = [], espera = [], aprovados = [], listaAprovadosData = [], bannerSalvo="";

/* — INICIALIZA — */
async function inicializar(){
  const snap = await getDoc(docRef);
  if(!snap.exists()){
    await setDoc(docRef, {rank:[], espera:[], aprovados:[], banner:"" });
  }
}
await inicializar();

/* — REALTIME — */
onSnapshot(docRef, snap => {
  if(snap.exists()){
    const d = snap.data();
    rank = d.rank||[];
    espera = d.espera||[];
    aprovados = d.aprovados||[];
    listaAprovadosData = d.aprovados||[];
    bannerSalvo = d.banner||"";
    bannerImg.src = bannerSalvo;
    renderRank();
    renderAdmin();
  }
});

/* — SALVAR FIRESTORE — */
async function salvar(){
  await setDoc(docRef, {
    rank:rank,
    espera:espera,
    aprovados:aprovados,
    banner:bannerSalvo
  });
}

/* — MODAIS — */
window.abrirModal = ()=> modalCadastro.classList.remove("hidden");
window.fecharModal = ()=> modalCadastro.classList.add("hidden");
window.abrirLogin = ()=> modalLogin.classList.remove("hidden");
window.fecharLogin = ()=> modalLogin.classList.add("hidden");

/* — CADASTRAR — */
window.solicitarEntrada = async ()=>{
  const nome = regNome.value.trim();
  const email = regEmail.value.trim();
  const fone = regFone.value.trim();

  if(!nome||!email||!fone){ alert("Preencha todos"); return;}

  const existe = [...espera, ...listaAprovadosData]
  .some(u => u.email===email || u.nome===nome);

  if(existe){ alert("Já cadastrado!"); return;}

  const eClan = confirm("Você é de algum clan?");
  let clan = "";
  if(eClan){
    clan = prompt("Qual nome do clan?");
    if(!clan){ alert("Informe o clan"); return;}
  }

  espera.push({
    nome,email,fone,clan,
    senha:"", primeiroAcesso:true, id:Date.now()
  });

  await salvar();
  alert("Cadastro enviado!");
  fecharModal();
};

/* — LOGIN — */
window.fazerLogin = async ()=>{
  const email = loginEmail.value.trim();
  const senha = loginSenha.value.trim();

  const user = listaAprovadosData.find(u => u.email===email);

  if(!user){
    alert("Usuário não aprovado!");
    return;
  }

  if(user.primeiroAcesso){
    const nova = prompt("Primeiro acesso! Crie uma senha alfanumérica (mín 6)");
    if(!nova||nova.length<6||!/\d/.test(nova)||!/[a-zA-Z]/.test(nova)){
      alert("Senha inválida!"); return;
    }
    user.senha = nova;
    user.primeiroAcesso = false;
    await salvar();
    alert("Senha criada! Faça login novamente.");
    return;
  }

  if(user.senha!==senha){
    alert("Senha incorreta!");
    return;
  }

  alert(`Bem-vindo ${user.nome} ${user.clan? "- Clan: "+user.clan:""}`);
  fecharLogin();
};

/* — ADMIN — */
window.loginAdmin = ()=>{
  const s = prompt("Senha admin:");
  if(s==="123"){
    document.querySelectorAll(".admin-only")
    .forEach(e=>e.style.display="block");
  }
};

window.aprovar = async (id)=>{
  const idx=espera.findIndex(p=>p.id===id);
  if(idx===-1)return;

  const j=espera.splice(idx,1)[0];
  aprovados.push(j);
  await salvar();
};

window.reprovar = async(id)=>{
  espera = espera.filter(p=>p.id!==id);
  await salvar();
};

function renderRank(){
  rankBody.innerHTML="";
  rank.forEach((p,i)=>{
    rankBody.innerHTML += `
    <tr class="border-b border-zinc-800">
      <td class="p-4">#${i+1}</td>
      <td class="p-4">${p.nome}</td>
      <td class="p-4 text-center">${p.matches}</td>
      <td class="p-4 text-center text-red-500">${p.kills}</td>
    </tr>`;
  });
}

function renderAdmin(){
  contagemAprovados.textContent=listaAprovadosData.length;

  listaEspera.innerHTML="";
  espera.forEach(p=>{
    listaEspera.innerHTML+=`
    <div class="bg-black p-2 rounded flex justify-between">
      <span>${p.nome}</span>
      <div>
        <button onclick="aprovar(${p.id})" class="bg-green-600 px-2 py-1 text-xs">V</button>
        <button onclick="reprovar(${p.id})" class="bg-red-600 px-2 py-1 text-xs">X</button>
      </div>
    </div>`;
  });

  listaAprovados.innerHTML="";
  listaAprovadosData.forEach(p=>{
    listaAprovados.innerHTML+=`
    <div class="bg-black p-2 rounded">
      ${p.nome} ${p.clan? "- Clan: "+p.clan:""}
    </div>`;
  });
}
</script>

</body>
</html>
