import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
  getAuth, 
  createUserWithEmailAndPassword, 
  signInWithEmailAndPassword 
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

import { 
  getFirestore, 
  doc, 
  setDoc, 
  getDoc, 
  collection,
  addDoc,
  onSnapshot,
  updateDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* SEU FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyDkwukyKZVEZKiP4J75tkUNDisqaC4KLlk",
  authDomain: "equipeodio-715f6.firebaseapp.com",
  projectId: "equipeodio-715f6",
  storageBucket: "equipeodio-715f6.firebasestorage.app",
  messagingSenderId: "399735990964",
  appId: "1:399735990964:web:6baa2428bc49c23d7845e1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const docRef = doc(db,"site","dados");

let aprovados=[];
let bannerSalvo="https://images.alphacoders.com";

/* =========================
   ALISTAR-SE
========================= */

window.abrirModal = async ()=>{
  const nome = prompt("Nome no COD:");
  const email = prompt("Seu Email:");

  if(!nome || !email) return alert("Preencha tudo");

  await addDoc(collection(db,"alistamentos"),{
    nome,
    email,
    aprovado:false
  });

  alert("Pedido enviado! Aguarde aprovação do admin.");
};

/* =========================
   LOGIN
========================= */

window.abrirLogin = async ()=>{
  const email = prompt("Digite seu email:");

  if(!email) return;

  const senha = prompt("Digite sua senha:");

  try{
    await signInWithEmailAndPassword(auth,email,senha);
    alert("Login realizado!");
  }catch(e){

    if(e.code==="auth/user-not-found"){
      alert("Primeiro acesso! Crie sua senha.");

      const novaSenha = prompt("Crie uma senha alfanumérica:");

      if(!novaSenha || novaSenha.length < 6)
        return alert("Senha fraca!");

      try{
        await createUserWithEmailAndPassword(auth,email,novaSenha);
        alert("Conta criada!");
      }catch(err){
        alert("Erro: "+err.message);
      }

    }else{
      alert("Erro: "+e.message);
    }
  }
};

/* =========================
   ADMIN APROVAR
========================= */

window.loginAdmin = ()=>{
  const senha = prompt("Senha Admin:");
  if(senha==="123"){
    document.body.classList.add("admin-active");
    carregarPedidos();
  }
};

window.logoutAdmin = ()=>{
  document.body.classList.remove("admin-active");
};

/* LISTAR PEDIDOS */
function carregarPedidos(){
  onSnapshot(collection(db,"alistamentos"), snap=>{
    snap.forEach(docSnap=>{
      const d = docSnap.data();

      if(!d.aprovado){
        const aprovar = confirm("Aprovar "+d.nome+" ?");
        if(aprovar){
          aprovarUsuario(docSnap.id,d);
        }
      }
    });
  });
}

/* APROVAR */
async function aprovarUsuario(id,dados){

  await updateDoc(doc(db,"alistamentos",id),{
    aprovado:true
  });

  aprovados.push({
    nome:dados.nome,
    matches:0,
    kills:0
  });

  await salvar();
}

/* =========================
   RANK
========================= */

onSnapshot(docRef, async snap=>{
  if(!snap.exists()){
    await setDoc(docRef,{rank:[],banner:bannerSalvo});
    return;
  }

  const d = snap.data();
  aprovados = d.rank || [];
  bannerSalvo = d.banner || bannerSalvo;
  document.getElementById("bannerImg").src = bannerSalvo;
  renderRank();
});

function salvar(){
  return setDoc(docRef,{
    rank:aprovados,
    banner:bannerSalvo
  },{merge:true});
}

function renderRank(){
  const rankBody = document.getElementById("rankBody");
  rankBody.innerHTML="";

  aprovados.forEach((p,i)=>{
    rankBody.innerHTML+=`
    <tr>
      <td>#${i+1}</td>
      <td>${p.nome}</td>
      <td>${p.matches||0}</td>
      <td>${p.kills||0}</td>
      <td class="admin-only">
        <button onclick="addScore('${p.nome}')">+K</button>
      </td>
    </tr>`;
  });
}

window.addScore = nome=>{
  const k=parseInt(prompt("Kills","0"))||0;
  const idx=aprovados.findIndex(p=>p.nome===nome);
  if(idx>-1){
    aprovados[idx].matches++;
    aprovados[idx].kills+=k;
    salvar();
  }
};

/* =========================
   SORTEADOR
========================= */

window.sortearEquipes = ()=>{
  if(aprovados.length<2) return alert("Precisa de 2");

  const lista=[...aprovados].sort(()=>Math.random()-0.5);
  const metade=Math.ceil(lista.length/2);

  const t1=lista.slice(0,metade).map(p=>p.nome);
  const t2=lista.slice(metade).map(p=>p.nome);

  document.getElementById("equipesContainer").innerHTML=
  `<div class="equipe bg-red-500">Equipe 1: ${t1.join(", ")}</div>
   <div class="equipe bg-blue-500">Equipe 2: ${t2.join(", ")}</div>`;
};
