<!-- MODAL ALISTAMENTO COMPLETO -->
<div id="modalCadastro" class="fixed inset-0 bg-black/90 flex items-center justify-center hidden p-4">
  <div class="bg-zinc-900 p-8 rounded border border-red-600 max-w-md w-full">
    <h2 class="text-2xl font-bold mb-6 text-center uppercase">Alistamento / Entrar</h2>

    <!-- CADASTRO (pedido de aprovação) -->
    <input id="regNome" placeholder="Nome no COD" class="w-full bg-black border border-zinc-700 p-3 rounded text-white mb-2">
    <input id="regEmail" placeholder="Email" type="email" class="w-full bg-black border border-zinc-700 p-3 rounded text-white mb-2">
    <input id="regFone" placeholder="Telefone" class="w-full bg-black border border-zinc-700 p-3 rounded text-white mb-2">
    <button onclick="solicitarEntrada()" class="w-full bg-red-600 py-3 font-bold uppercase mb-2">Enviar Cadastro</button>

    <hr class="border-zinc-700 my-2">

    <!-- LOGIN DE APROVADOS -->
    <input id="loginNomeModal" placeholder="Nome no COD" class="w-full bg-black border border-zinc-700 p-3 rounded text-white mb-2">
    <input id="loginSenhaModal" type="password" placeholder="Senha" class="w-full bg-black border border-zinc-700 p-3 rounded text-white mb-2">
    <button onclick="loginJogadorModal()" class="w-full bg-blue-600 py-3 font-bold uppercase">Entrar</button>

    <button onclick="fecharModalCadastro()" class="w-full text-zinc-600 text-xs uppercase mt-2">Fechar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDkwukyKZVEZKiP4J75tkUNDisqaC4KLlk",
  authDomain: "equipeodio-715f6.firebaseapp.com",
  projectId: "equipeodio-715f6",
  storageBucket: "equipeodio-715f6.firebasestorage.app",
  messagingSenderId: "399735990964",
  appId: "1:399735990964:web:6baa2428bc49c23d7845e1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const docRef = doc(db,"site","dados");

let aprovados=[], espera=[], listaAprovadosData=[], bannerSalvo="https://images.alphacoders.com", isAdmin=false;

async function inicializar(){ 
  const snap = await getDoc(docRef);
  if(!snap.exists()) await setDoc(docRef,{rank:[],espera:[],aprovados:[],banner:bannerSalvo});
}
await inicializar();

onSnapshot(docRef, snap=>{
  if(snap.exists()){
    const d = snap.data();
    aprovados=d.rank||[];
    espera=d.espera||[];
    listaAprovadosData=d.aprovados||[];
    bannerSalvo=d.banner||bannerSalvo;
    document.getElementById("bannerImg").src=bannerSalvo;
    renderRank(); renderAdmin();
  }
});

async function salvar(){ await setDoc(docRef,{rank:aprovados,espera:espera,aprovados:listaAprovadosData,banner:bannerSalvo}); }

window.abrirModal = ()=> modalCadastro.classList.remove("hidden");
window.fecharModalCadastro = ()=> modalCadastro.classList.add("hidden");

window.solicitarEntrada = async ()=>{
  const nome=regNome.value.trim();
  const email=regEmail.value.trim();
  const fone=regFone.value.trim();
  if(!nome||!email||!fone){ alert("Preencha todos os campos!"); return; }

  const duplicado=[...espera,...listaAprovadosData].some(p=>p.nome===nome || p.email===email || p.fone===fone);
  if(duplicado){ alert("Já cadastrado!"); return; }

  espera.push({nome,email,fone,id:Date.now()});
  await salvar();
  alert("Pedido enviado com sucesso! Aguarde aprovação do admin.");
  regNome.value=""; regEmail.value=""; regFone.value="";
  fecharModalCadastro();
};

window.loginJogadorModal = async ()=>{
  const nome = loginNomeModal.value.trim();
  const senha = loginSenhaModal.value.trim();
  const aprovado = listaAprovadosData.find(p=>p.nome===nome);

  if(!aprovado){
    alert("Você ainda não foi aprovado pelo admin!");
    return;
  }

  // PRIMEIRO ACESSO (sem senha)
  if(!aprovado.senha){
    let novaSenha = prompt("Primeiro acesso! Crie uma senha alfanumérica (mínimo 6 dígitos):");
    if(!novaSenha || novaSenha.length<6 || !/\d/.test(novaSenha) || !/[a-zA-Z]/.test(novaSenha)){
      alert("Senha inválida!");
      return;
    }
    aprovado.senha = novaSenha;

    // Pergunta sobre clan
    let clanSim = confirm("Você é de clan?");
    if(clanSim){
      let clanNome = prompt("Qual o nome do clan?");
      aprovado.clan = clanNome || "";
    } else {
      aprovado.clan = "";
    }

    await salvar();
    alert("Cadastro completo! Agora você pode entrar com sua senha.");
    loginNomeModal.value = ""; loginSenhaModal.value = "";
    return;
  }

  // LOGIN NORMAL
  if(senha !== aprovado.senha){
    alert("Senha incorreta!");
    return;
  }

  alert(`Bem-vindo ${aprovado.nome}${aprovado.clan ? " do clan "+aprovado.clan : ""}!`);
  loginNomeModal.value = ""; loginSenhaModal.value = "";
  fecharModalCadastro();
};
</script>
