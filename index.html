<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Equipe ODIO</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
body{background:#0b0b0b;color:#fff;font-family:Arial;}
.admin-only{display:none;}
.admin-active .admin-only{display:table-cell;}
.admin-active #btnLogout{display:inline-block;}
#btnLogout{display:none;}
button{cursor:pointer;padding:4px 8px;border-radius:4px;}
</style>
</head>

<body>

<h1 style="text-align:center;padding:20px;">Equipe ODIO</h1>

<div style="text-align:center;margin-bottom:20px;">
<button onclick="abrirModal()">Alistar-se</button>
<button onclick="abrirLogin()">Login</button>
<button onclick="loginAdmin()">Admin</button>
<button id="btnLogout" onclick="logoutAdmin()">Sair</button>
</div>

<table border="1" width="100%" cellpadding="8">
<thead>
<tr>
<th>#</th>
<th>Nome</th>
<th>Partidas</th>
<th>Kills</th>
<th class="admin-only">Ações</th>
</tr>
</thead>
<tbody id="rankBody"></tbody>
</table>

<div class="admin-only" style="margin-top:20px;text-align:center;">
<button onclick="sortearEquipes()">Sortear Times</button>
<div id="equipesContainer"></div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  updateDoc,
  doc,
  query,
  where,
  getDocs
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* SEU FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyDkwukyKZVEZKiP4J75tkUNDisqaC4KLlk",
  authDomain: "equipeodio-715f6.firebaseapp.com",
  projectId: "equipeodio-715f6",
  storageBucket: "equipeodio-715f6.firebasestorage.app",
  messagingSenderId: "399735990964",
  appId: "1:399735990964:web:6baa2428bc49c23d7845e1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let aprovados=[];

/* ================= LER APROVADOS EXISTENTES ================= */
onSnapshot(collection(db,"alistamentos"), snap=>{
  aprovados=[];

  snap.forEach(docSnap=>{
    const d = docSnap.data();

    if(d.aprovado===true){
      aprovados.push({
        id:docSnap.id,
        nome:d.nome,
        email:d.email,
        matches:d.matches||0,
        kills:d.kills||0
      });
    }
  });

  renderRank();
});

/* ================= ALISTAR ================= */
window.abrirModal = async ()=>{
  const nome = prompt("Nome no COD:");
  const email = prompt("Seu Email:");

  if(!nome || !email) return alert("Preencha tudo");

  await addDoc(collection(db,"alistamentos"),{
    nome,
    email,
    aprovado:false,
    matches:0,
    kills:0
  });

  alert("Pedido enviado! Aguarde aprovação.");
};

/* ================= LOGIN ================= */
window.abrirLogin = async ()=>{
  const email = prompt("Digite seu email:");
  if(!email) return;

  const q = query(
    collection(db,"alistamentos"),
    where("email","==",email),
    where("aprovado","==",true)
  );

  const snap = await getDocs(q);

  if(snap.empty){
    return alert("Você não foi aprovado ainda.");
  }

  const senha = prompt("Digite sua senha:");

  try{
    await signInWithEmailAndPassword(auth,email,senha);
    alert("Login realizado!");
  }
  catch(e){

    if(e.code==="auth/user-not-found"){
      const novaSenha = prompt("Primeiro acesso! Crie uma senha (mín 6 caracteres):");

      if(!novaSenha || novaSenha.length<6)
        return alert("Senha fraca!");

      await createUserWithEmailAndPassword(auth,email,novaSenha);
      alert("Conta criada! Agora faça login novamente.");
    }
    else{
      alert("Erro: "+e.message);
    }
  }
};

/* ================= ADMIN ================= */
window.loginAdmin = ()=>{
  const senha = prompt("Senha Admin:");
  if(senha==="123"){
    document.body.classList.add("admin-active");
  }
};

window.logoutAdmin = ()=>{
  document.body.classList.remove("admin-active");
};

/* ================= RENDER ================= */
function renderRank(){
  const body=document.getElementById("rankBody");
  body.innerHTML="";

  aprovados
  .sort((a,b)=>b.kills-a.kills)
  .forEach((p,i)=>{
    body.innerHTML+=`
    <tr>
      <td>${i+1}</td>
      <td>${p.nome}</td>
      <td>${p.matches}</td>
      <td>${p.kills}</td>
      <td class="admin-only">
        <button onclick="addScore('${p.id}')">+K</button>
      </td>
    </tr>`;
  });
}

/* ================= ADD SCORE ================= */
window.addScore = async id=>{
  const k=parseInt(prompt("Quantas kills?","0"))||0;

  const jogador=aprovados.find(p=>p.id===id);
  if(!jogador) return;

  await updateDoc(doc(db,"alistamentos",id),{
    matches:jogador.matches+1,
    kills:jogador.kills+k
  });
};

/* ================= SORTEADOR ================= */
window.sortearEquipes = ()=>{
  if(aprovados.length<2)
    return alert("Precisa de pelo menos 2 jogadores");

  const lista=[...aprovados].sort(()=>Math.random()-0.5);
  const metade=Math.ceil(lista.length/2);

  const t1=lista.slice(0,metade).map(p=>p.nome);
  const t2=lista.slice(metade).map(p=>p.nome);

  document.getElementById("equipesContainer").innerHTML=
  `<p>Equipe 1: ${t1.join(", ")}</p>
   <p>Equipe 2: ${t2.join(", ")}</p>`;
};

</script>

</body>
</html>
