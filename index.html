<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Equipe ODIO</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#0b0b0b;color:#fff;font-family:Arial;}
.admin-only{display:none;}
.admin-active .admin-only{display:inline-block;}
.admin-active .admin-table{display:table-cell;}
.admin-active #btnLogout{display:inline-block;}
#btnLogout{display:none;}
button{cursor:pointer;padding:6px 10px;border-radius:4px;background:#222;margin:2px;}
</style>
</head>
<body>

<img id="bannerImg" style="width:100%;height:220px;object-fit:cover;">

<h1 style="text-align:center;padding:15px;">Equipe ODIO</h1>

<div style="text-align:center;">
<button onclick="abrirModal()">Alistar-se</button>
<button onclick="abrirLogin()">Login</button>
<button onclick="loginAdmin()">Admin</button>
<button id="btnLogout" onclick="logoutAdmin()">Sair</button>
<button class="admin-only" onclick="alterarBanner()">Alterar Banner</button>
</div>

<table border="1" width="100%" cellpadding="8">
<thead>
<tr>
<th>#</th>
<th>Nome</th>
<th>Partidas</th>
<th>Kills</th>
<th class="admin-table">Ações</th>
</tr>
</thead>
<tbody id="rankBody"></tbody>
</table>

<div class="admin-only" style="margin-top:20px;">
<h3>Pendentes</h3>
<div id="pendentes"></div>

<h3>Sorteador</h3>
<button onclick="sortearEquipes()">Sortear Times</button>
<div id="equipesContainer"></div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

import { 
getFirestore, collection, addDoc, onSnapshot,
updateDoc, doc, query, where, getDocs,
deleteDoc, setDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDkwukyKZVEZKiP4J75tkUNDisqaC4KLlk",
  authDomain: "equipeodio-715f6.firebaseapp.com",
  projectId: "equipeodio-715f6",
  storageBucket: "equipeodio-715f6.firebasestorage.app",
  messagingSenderId: "399735990964",
  appId: "1:399735990964:web:6baa2428bc49c23d7845e1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let aprovados=[];
let pendentes=[];

/* ================= BANNER ================= */
const siteRef = doc(db,"site","dados");

onSnapshot(siteRef, async snap=>{
  if(!snap.exists()) return;

  const d = snap.data();
  if(d?.banner){
    const img=document.getElementById("bannerImg");
    if(img) img.src=d.banner;
  }
});

/* ================= JOGADORES ================= */
onSnapshot(collection(db,"alistamentos"), snap=>{
  aprovados=[];
  pendentes=[];

  snap.forEach(docSnap=>{
    const d=docSnap.data();

    if(d?.aprovado===true){
      aprovados.push({
        id:docSnap.id,
        nome:d.nome||"",
        email:d.email||"",
        matches:d.matches||0,
        kills:d.kills||0
      });
    }else{
      pendentes.push({
        id:docSnap.id,
        nome:d?.nome||"Sem nome"
      });
    }
  });

  renderRank();
  renderPendentes();
});

/* ================= FUNÇÕES ================= */

window.abrirModal = async ()=>{
  const nome=prompt("Nome:");
  const email=prompt("Email:");
  if(!nome||!email) return;

  await addDoc(collection(db,"alistamentos"),{
    nome,email,aprovado:false,matches:0,kills:0
  });

  alert("Enviado!");
};

window.abrirLogin = async ()=>{
  const email=prompt("Email:");
  if(!email) return;

  const q=query(collection(db,"alistamentos"),
  where("email","==",email),
  where("aprovado","==",true));

  const snap=await getDocs(q);
  if(snap.empty) return alert("Não aprovado");

  const senha=prompt("Senha:");

  try{
    await signInWithEmailAndPassword(auth,email,senha);
    alert("Login OK");
  }catch(e){
    if(e.code==="auth/user-not-found"){
      const nova=prompt("Crie senha (mín 6):");
      if(!nova||nova.length<6) return;
      await createUserWithEmailAndPassword(auth,email,nova);
      alert("Conta criada");
    }else{
      alert("Erro: "+e.message);
    }
  }
};

window.loginAdmin=()=>{
  if(prompt("Senha admin:")==="123"){
    document.body.classList.add("admin-active");
  }
};

window.logoutAdmin=()=>{
  document.body.classList.remove("admin-active");
};

window.alterarBanner=async()=>{
  const url=prompt("Nova URL:");
  if(!url) return;
  await setDoc(siteRef,{banner:url},{merge:true});
};

window.aprovar=async(id)=>{
  await updateDoc(doc(db,"alistamentos",id),{aprovado:true});
};

window.remover=async(id)=>{
  if(confirm("Remover?")){
    await deleteDoc(doc(db,"alistamentos",id));
  }
};

window.addScore=async(id)=>{
  const k=parseInt(prompt("Kills?","0"))||0;
  const j=aprovados.find(p=>p.id===id);
  if(!j) return;

  await updateDoc(doc(db,"alistamentos",id),{
    matches:j.matches+1,
    kills:j.kills+k
  });
};

window.sortearEquipes=()=>{
  if(aprovados.length<2) return alert("Precisa de 2");

  const lista=[...aprovados].sort(()=>Math.random()-0.5);
  const metade=Math.ceil(lista.length/2);

  const t1=lista.slice(0,metade).map(p=>p.nome);
  const t2=lista.slice(metade).map(p=>p.nome);

  document.getElementById("equipesContainer").innerHTML=
  `<p>Equipe 1: ${t1.join(", ")}</p>
   <p>Equipe 2: ${t2.join(", ")}</p>`;
};

function renderRank(){
  const body=document.getElementById("rankBody");
  body.innerHTML="";

  aprovados.sort((a,b)=>b.kills-a.kills)
  .forEach((p,i)=>{
    body.innerHTML+=`
    <tr>
      <td>${i+1}</td>
      <td>${p.nome}</td>
      <td>${p.matches}</td>
      <td>${p.kills}</td>
      <td class="admin-table">
        <button onclick="addScore('${p.id}')">+K</button>
        <button onclick="remover('${p.id}')">X</button>
      </td>
    </tr>`;
  });
}

function renderPendentes(){
  const div=document.getElementById("pendentes");
  div.innerHTML="";
  pendentes.forEach(p=>{
    div.innerHTML+=`
    <p>${p.nome}
    <button onclick="aprovar('${p.id}')">Aprovar</button>
    </p>`;
  });
}

</script>
</body>
</html>
